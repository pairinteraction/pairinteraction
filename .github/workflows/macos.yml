name: macOS

on:
  push:
  pull_request:
    types: [opened, reopened]
  workflow_call:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: false

# https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
env:
  CMAKE_BUILD_PARALLEL_LEVEL: 3
  CTEST_PARALLEL_LEVEL: 3
  CTEST_OUTPUT_ON_FAILURE: 1
  VERBOSE: 1

jobs:
  macos:
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install boost cereal doctest spdlog eigen fmt gsl lapack nlohmann-json cpp-httplib uv graphviz tbb

      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Python dependencies for cmake
        run: uv pip install --system --break-system-packages --no-cache-dir nanobind numpy

      - name: Configure
        run: cmake -S . -B build/ -DBUILD_TESTING=On -DPython_FIND_FRAMEWORK=LAST
      - name: Build
        run: cmake --build build/ -- --keep-going
      - name: Test
        run: cmake --build build/ --target test -- --keep-going

      - name: Run debugging session in tmate
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled && always()
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

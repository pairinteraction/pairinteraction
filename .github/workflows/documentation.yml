name: Documentation

on:
  push:
    branches: ["*"]
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_call:
  workflow_dispatch:

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 2
  CTEST_PARALLEL_LEVEL: 2
  CTEST_OUTPUT_ON_FAILURE: 1
  CLICOLOR_FORCE: 1
  VERBOSE: 1
  CXXFLAGS: "-march=x86-64-v3"

jobs:
  build_latest_sphinx:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/pairinteraction/pairinteraction-debian:docker
    steps:
    - uses: actions/checkout@v5
    - name: Setup uv project virtual environment
      uses: ./.github/actions/setup-uv-all-deps
    - name: Install PairInteraction into virtual environment
      run: uv pip install .[docs]
    - name: Build documentation
      working-directory: docs/
      run: uv run --no-project make html SPHINXOPTS="-W --keep-going"  # TODO also use -n in the future

  build_sphinx_polyversion:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/pairinteraction/pairinteraction-debian:docker
      options: --user 1001  # workaround see https://github.com/actions/runner/issues/2033#issuecomment-1598547465
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    - name: Fetch branch master to local branch  # needed for sphinx-polyversion to recognize the branch
      run: git fetch origin master:master || true  # ignore error if branch already exists
    - name: Setup uv project virtual environment
      uses: ./.github/actions/setup-uv-all-deps
    - name: Install PairInteraction into virtual environment
      run: uv pip install .[docs]
    - name: Setup 2nd virtual environment for PairInteraction v0.9.10
      run: |
        uv venv venv_pairinteraction_v0.9.10 --python=python3.11
        uv pip install --python venv_pairinteraction_v0.9.10/bin/python 'pairinteraction==0.9.10' sphinx nbsphinx 'sphinxcontrib-mermaid<1' sphinx_rtd_theme sphinx_polyversion
    - name: Build documentation
      run: uv run --no-project sphinx-polyversion docs/poly.py
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pairinteraction-docs
        path: docs/_build_polyversion/

  coverage_cpp_pytest:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/pairinteraction/pairinteraction-debian:docker
    steps:
    - uses: actions/checkout@v5
    - name: Setup uv project virtual environment
      uses: ./.github/actions/setup-uv-all-deps
    - name: Install PairInteraction into virtual environment
      run: uv pip install -Cbuild-dir=build --config-settings=cmake.define.WITH_COVERAGE=ON .[tests]
    - name: Run pytest
      run: uv run --no-project pytest
    - name: Generate Code Coverage HTML report
      working-directory: build/
      run: |
        lcov --directory . --capture --output-file coverage.info;
        lcov --remove coverage.info '/usr/*' '/opt/*' '/tmp/*' '*/_deps/*' '*/.cache/uv/*' '*/setup-uv-cache/*' '*/.venv/*' '*/.local/*' --output-file coverage.info;
        genhtml coverage.info --output-directory docs/coverage/ --rc genhtml_med_limit=50 --rc genhtml_hi_limit=75
    - name: Generate Code Coverage Badge
      working-directory: build/
      run: |
        uv pip install genbadge[all] lcov_cobertura
        uv run --no-project lcov_cobertura coverage.info -o coverage.xml
        uv run --no-project genbadge coverage -i coverage.xml -o docs/coverage/badge.svg -n "C++ coverage"
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pairinteraction-coverage-cpp-pytest
        path: build/docs/coverage

  coverage_python_pytest:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/pairinteraction/pairinteraction-debian:docker
    steps:
    - uses: actions/checkout@v5
    - name: Setup uv project virtual environment
      uses: ./.github/actions/setup-uv-all-deps
    - name: Install PairInteraction into virtual environment
      run: uv pip install -e .[tests]  # -e is needed for coverage to work
    - name: Run pytest with coverage
      run: |  # also run with --generate-reference to get 100% tests coverage and test the reference generation
        uv run --no-project coverage run --source=src,tests -m pytest
        uv run --no-project coverage run --append --source=src,tests -m pytest --generate-reference
        uv run --no-project coverage run --append --source=src,tests -m pytest
    - name: Generate Code Coverage HTML report
      run: |
        uv run --no-project coverage lcov -o coverage.info
        genhtml coverage.info --output-directory docs/coverage/ --rc genhtml_med_limit=50 --rc genhtml_hi_limit=75
    - name: Generate Code Coverage Badge
      run: |
        uv pip install genbadge[all]
        uv run --no-project coverage xml -o coverage.xml
        uv run --no-project genbadge coverage -i coverage.xml -o docs/coverage/badge.svg -n "Python coverage"
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pairinteraction-coverage-python-pytest
        path: docs/coverage

  deploy_docs:
    needs: [build_latest_sphinx, build_sphinx_polyversion, coverage_cpp_pytest, coverage_python_pytest]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v5

    - name: Download artifacts docs
      uses: actions/download-artifact@v5
      with:
        name: pairinteraction-docs
        path: public/

    - name: Download artifacts coverage-cpp-pytest
      uses: actions/download-artifact@v5
      with:
        name: pairinteraction-coverage-cpp-pytest
        path: public/coverage/cpp-pytest

    - name: Download artifacts coverage-python-pytest
      uses: actions/download-artifact@v5
      with:
        name: pairinteraction-coverage-python-pytest
        path: public/coverage/python-pytest

    - name: Deploy pages
      uses: JamesIves/github-pages-deploy-action@v4.7.3
      with:
        branch: gh-pages
        folder: public
        single-commit: true
        dry-run: ${{ !(github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')) }}
